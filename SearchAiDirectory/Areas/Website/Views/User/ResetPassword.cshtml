@{
    Layout = "_Layout";
    ViewData["Title"] = "ResetPassword";
    ViewData["Meta-Description"] = "Reset your password for GetDigitalContent, a social media platform. Enter your a new password anc confirm that password.";
    ViewData["Meta-Keywords"] = "GetDigitalContent, social media, reset password";
}

<!-- Reset Password View-->
<div class="col-12 col-md-5 col-xl-4 my-5">

    <!-- Heading -->
    <h1 class="display-4 text-center mb-3">Reset Password</h1>

    <!-- Subheading -->
    <p class="text-muted text-center mb-5">Enter a new password and confirm that password.</p>

    <!-- Form -->
    <form method="post" id="reset-password-form" onsubmit="event.preventDefault(); onSubmitForm();" action="/ResetPassword" class="needs-validation" novalidate>
        <input type="hidden" id="email" name="email" value="@ViewBag.Email" />

        <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="password" />
        </div>

        <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input type="password" id="confim-password" name="confim-password" class="form-control" placeholder="confirm password" />
        </div>

        <div class="text-center g-recaptcha" id="html_element"></div>
        <div class="pb-2"><p class="form-text text-danger" id="invalidMessage"></p></div>

        <button id="ResetPasswordButton" type="submit" class="btn btn-lg w-100 btn-primary my-3">Reset Password</button>
    </form>

    <div class="text-center">
        <small class="text-muted text-center">
            Remember your password? <a href="/Login">Log in</a>.
        </small>
        <br />
        <small class="text-muted text-center">
            Don't have an account? <a href="/Signup">SignUp</a>.
        </small>
    </div>

</div>

@section Scripts{
    <script src="https://www.google.com/recaptcha/api.js?trustedtypes=true&onload=onloadCallback&render=explicit" async defer></script>
    <script>

        function onSubmitForm() {

            updateSubmitButton(true);

            var validPassword = validatePassword();
            if (validPassword == false) { updateSubmitButton(); return false; }

            if (recaptcha_verified == false) { updateSubmitButton(); m.innerHTML = "Please validate that you are not a robot."; return false; }
            document.getElementById('reset-password-form').submit();

            return false;
        }

        const m = document.getElementById('invalidMessage');
        const b = document.getElementById('ResetPasswordButton');

        var recaptcha_verified = false;
        var onloadCallback = function () {

            grecaptcha.render('html_element', {
                'sitekey': '6Ld7PRIjAAAAAG31jBGEdU3KKGUZyXBV2HSkwOp7',
                'callback': function (token) {
                    recaptcha_verified = true;
                },
                'expired-callback': function () {
                    m.innerHTML = "Unable to Submit Form.";
                },
                'error-callback': function () {
                    m.innerHTML = "Unable to Submit Form.";
                },
                'data-size': "compact"
            });

        };

        function validatePassword() {
            var p = document.getElementById('password').value;
            var c = document.getElementById('confim-password').value;
            var returnValue = false;

            var errors = [];
            if (p.length < 8) {
                errors.push("The password must be at least 8 characters.");
            }
            if (p.search(/[a-z]/i) < 0) {
                errors.push("The password must contain at least one letter.");
            }
            if (p.search(/[0-9]/) < 0) {
                errors.push("The password must contain at least one digit.");
            }
            if (p != c) {
                errors.push("The password and confirm password must be the same.");
            }
            if (errors.length > 0) {
                m.innerHTML = errors.join("\n");
                returnValue = false;
            }
            else {
                m.innerHTML = "";
                returnValue = true;
            }
            return returnValue;
        }

        function updateSubmitButton(submitting) {
            if (submitting == true) {
                b.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Loading';
                b.disabled = true;
            }
            else {
                b.innerHTML = 'Reset Password';
                b.disabled = false;
            }
        }
    </script>
}